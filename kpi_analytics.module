<?php

/**
 * @file
 * Contains kpi_analytics.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Field\FieldStorageDefinitionInterface;
use Drupal\Core\Entity\FieldableEntityInterface;
use Drupal\Core\Block\BlockPluginInterface;

/**
 * Implements hook_help().
 */
function kpi_analytics_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the kpi_analytics module.
    case 'help.page.kpi_analytics':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Architecture for making Key Performance Indicators for your website.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Retrieve the Datasource plugins.
 */
function _kpi_datasource_allowed_values(FieldStorageDefinitionInterface $definition, FieldableEntityInterface $entity = NULL) {
  $kpi_datasources = \Drupal::service('plugin.manager.kpi_datasource.processor')
    ->getOptionsList();
  return $kpi_datasources;
}

/**
 * Retrieve the Data formatter plugins.
 */
function _kpi_data_formatter_allowed_values(FieldStorageDefinitionInterface $definition, FieldableEntityInterface $entity = NULL) {
  $kpi_datasources = \Drupal::service('plugin.manager.kpi_data_formatter.processor')
    ->getOptionsList();
  return $kpi_datasources;
}

/**
 * Retrieve the Data visualization plugins.
 */
function _kpi_visualization_allowed_values(FieldStorageDefinitionInterface $definition, FieldableEntityInterface $entity = NULL) {
  $kpi_datasources = \Drupal::service('plugin.manager.kpi_visualization.processor')
    ->getOptionsList();
  return $kpi_datasources;
}

/**
 * Implements hook_preprocess_block().
 */
function kpi_analytics_preprocess_block(&$variables) {

  if ($variables['base_plugin_id'] === 'block_content' &&
    isset($variables['content']['#block_content']) &&
    $variables['content']['#block_content']->bundle() === 'kpi_analytics'
  ) {

    // TODO: work on caching and preferable use the hook below to render the output.
    // TODO: See how we can render this in the template without moving this.
    $variables['content']['kpi_analytics'] = $variables['elements']['kpi_analytics'];
  }
}

/**
 * Implements hook_block_view_BASE_BLOCK_ID_alter().
 */
function kpi_analytics_block_view_block_content_alter(&$build, BlockPluginInterface $block) {
  if ($block_entity = _kpi_analytics_is_kpi_block($block)) {
    //$build['test']['#markup'] = 'Hello world';

    $build['kpi_analytics'] = [
      '#lazy_builder' => [
        'kpi_analytics.kpi_builder:build',
        [
          $block_entity->getEntityTypeId(),
          $block_entity->id(),
        ]
      ],
      '#create_placeholder' => TRUE,
    ];
  }
}

/**
 * Checks if a block is a kpi analytics block.
 */
function _kpi_analytics_is_kpi_block(BlockPluginInterface $block) {
  if ($block->getBaseId() === 'block_content') {
    $uuid = preg_replace('/^block_content:/', '', $block->getPluginId());
    // Load the block entity.
    $block_entities = \Drupal::entityTypeManager()
      ->getStorage('block_content')
      ->loadByProperties(array('uuid' => $uuid));
    if ($block_entity = array_pop($block_entities)) {
      if ($block_entity->bundle() === 'kpi_analytics') {
        return $block_entity;
      }
    }
  }
  return FALSE;
}

/**
 * Implements hook_theme().
 */
function kpi_analytics_theme($existing, $type, $theme, $path) {
  return [
    'kpi_analytics_morris_chart' => [
      'template' => 'morris-chart',
      'path' => $path . '/templates',
      'variables' => [
        'type' => NULL,
        'uuid' => NULL,
        'labels' => [],
        'colors' => [],
      ],
    ],
  ];
}
